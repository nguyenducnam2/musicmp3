<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/layout.html}">
    <head>
        <title>title</title>
        <style>
            .card{
                max-width: 1000px;
                margin: 2vh;
            }
            .card-top{
                padding: 0.7rem 5rem;
            }
            .card-top a{
                float: left;
                margin-top: 0.7rem;
            }
            #logo{
                font-family: 'Dancing Script';
                font-weight: bold;
                font-size: 1.6rem;
            }
            .card-body{
                padding: 0 5rem 5rem 5rem;
                background-image: url("https://i.imgur.com/4bg1e6u.jpg");
                background-size: cover;
                background-repeat: no-repeat;
            }
            @media(max-width:768px){
                .card-body{
                    padding: 0 1rem 1rem 1rem;
                    background-image: url("https://i.imgur.com/4bg1e6u.jpg");
                    background-size: cover;
                    background-repeat: no-repeat;
                }
                .card-top{
                    padding: 0.7rem 1rem;
                }
            }
            .row{
                margin: 0;
            }
            .upper{
                padding: 1rem 0;
                justify-content: space-evenly;
            }
            #three{
                border-radius: 1rem;
                width: 22px;
                height: 22px;
                margin-right:3px;
                border: 1px solid blue;
                text-align: center;
                display: inline-block;
            }
            #payment{
                margin:0;
                color: blue;
            }
            .icons{
                margin-left: auto;
            }
            form span{
                color: rgb(179, 179, 179);
            }
            form{
                padding: 2vh 0;
            }
            input{
                border: 1px solid rgba(0, 0, 0, 0.137);
                padding: 1vh;
                margin-bottom: 4vh;
                outline: none;
                width: 100%;
                background-color: rgb(247, 247, 247);
            }
            input:focus::-webkit-input-placeholder
            {
                color:transparent;
            }
            .header{
                font-size: 1.5rem;
            }
            .left{
                background-color: #ffffff;
                padding: 2vh;
            }
            .left img{
                width: 2rem;
            }
            .left .col-4{
                padding-left: 0;
            }
            .right .item{
                padding: 0.3rem 0;
            }
            .right{
                background-color: #ffffff;
                padding: 2vh;
            }
            .col-8{
                padding: 0 1vh;
            }
            .lower{
                line-height: 2;
            }
            .btn{
                background-color: rgb(23, 4, 189);
                border-color: rgb(23, 4, 189);
                color: white;
                width: 100%;
                font-size: 0.7rem;
                margin: 4vh 0 1.5vh 0;
                padding: 1.5vh;
                border-radius: 0;
            }
            .btn:focus{
                box-shadow: none;
                outline: none;
                box-shadow: none;
                color: white;
                -webkit-box-shadow: none;
                -webkit-user-select: none;
                transition: none;
            }
            .btn:hover{
                color: white;
            }
            a{
                color: black;
            }
            a:hover{
                color: black;
                text-decoration: none;
            }
            input[type=checkbox]{
                width: unset;
                margin-bottom: unset;
            }
            #cvv{
                background-image: linear-gradient(to left, rgba(255, 255, 255, 0.575) , rgba(255, 255, 255, 0.541)), url("https://img.icons8.com/material-outlined/24/000000/help.png");
                background-repeat: no-repeat;
                background-position-x: 95%;
                background-position-y: center;
            }
            #cvv:hover{

            }
        </style>
    </head>
    <body>
        <div layout:fragment="content" id="content-page" class="content-page">
            <div class="container-fluid" th:if="${session.user !=null}">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-top border-bottom text-center">
                                <a href="http://localhost:8080">Back to shop</a>
                            </div>
                            <div class="card-body">
                                <div class="row upper">
                                    <span><i class="fa fa-check-circle-o"></i> Cart</span>
                                    <span id="payment"><span id="three">2</span>Checkout</span>
                                </div>
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="left border">
                                            <form>
                                                <h4>Personal Infomation</h4>
                                                <h6>Username:</h6>
                                                <input th:value="${user.username}" readonly>
                                                <h6>Email:</h6>
                                                <input th:value="${user.email}" readonly>
                                                <div class="row">
                                                    <div class="col-4"><h6>First Name:</h6>
                                                        <input th:value="${user.firstName}" readonly>
                                                    </div>
                                                    <div class="col-4"><h6>Last Name:</h6>
                                                        <input th:value="${user.lastName}" readonly>
                                                    </div>
                                                </div>
                                            </form>
                                            <div class="row">
                                                <span class="header">Payment Support</span>
                                                <div class="icons">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/174/174861.png?w=740&t=st=1659926924~exp=1659927524~hmac=cc4b6d082a23e117b92e5919322f4a4b22e02dbdf61a8ef37003d7092d2929ad"/>
                                                </div>
                                            </div>
                                        </div>    

                                    </div>
                                    <div class="col-md-5">
                                        <div class="right border">
                                            <div class="header">Order Summary</div>
                                            <p th:text="${items.size+' items'}"></p>
                                            <div class="row item" th:each="item:${items}">
                                                <div class="col-4 align-self-center"><img class="img-fluid" th:src="@{'/webdata/album/'+${item.song.album.image}}"></div>
                                                <div class="col-8">
                                                    <div class="row"><b>$ [[${item.song.price}]]</b></div>
                                                    <div class="row">[[${item.song.name}]]</div>
                                                    <div class="row text-muted">[[${item.song.artist.name}]]</div>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row lower">
                                                <div class="col text-left">Dicount Code</div>
                                                <input id="code" onchange="checkCode()"/>
                                                <span id='discount'></span>
                                            </div>

                                            <div class="row lower">
                                                <div class="col text-left">Subtotal</div>
                                                <div class="col text-right">$ [[${subTotal}]]</div>
                                            </div>
                                            <div class="row lower">
                                                <div class="col text-left"><b>Total to pay</b></div>
                                                <div class="col text-right" id='totalAfterDiscount'><b>$ [[${subTotal}]]</b></div>
                                            </div>
                                            <div class="row lower">
                                                <a style="color: white;" id="btnPay" class="btn">Order with Paypal</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" id="cartId" th:value="${cart.id}"/>
            <input type="hidden" id="total" th:value="${subTotal}"/>
            <input type="hidden" id="finishTotal"/>

            <script>
                let discount = document.querySelector('#discount');
                let code = document.querySelector('#code');

                let totalAfterDiscount = document.querySelector('#totalAfterDiscount');
                let total = document.querySelector('#total');
                let finishTotal = document.querySelector('#finishTotal');
                finishTotal.value = total.value;
                // dat bien fail
//                                                let total = document.querySelector('#total');
                function checkCode() {
                    //fetch(String , Object) 
                    fetch('http://localhost:8080/api/promotion/findByCode?code=' + code.value, {method: 'GET'})
                            .then((response) => response.json())
                            .then((response) => {
                                console.log(total.value);
                                finishTotal.value = total.value;
                                total.value = parseInt(total.value) - parseInt(total.value) * parseInt(response.promotion.discount) / 100
                                console.log(total.value);
                                document.querySelector('#totalAfterDiscount').innerHTML = '$' + total.value;
                                discount.innerHTML = "<p>Discount: " + response.promotion.discount + "%</p>";
                                document.querySelector('#btnPay').href = "http://localhost:8080/song/pay?total=" + total.value + "&cartId=" + document.querySelector('#cartId').value;

                            })
                            .catch(e => {
                                console.log(e);
                                total.value = finishTotal.value;
                                document.querySelector('#totalAfterDiscount').innerHTML = '$' + total.value;
                                discount.innerHTML = "<p style='color: red;' >Your code invalid</p>";
                            });
                }

                document.querySelector('#btnPay').href = "http://localhost:8080/song/pay?total=" + total.value + "&cartId=" + document.querySelector('#cartId').value;
            </script>
        </div>
    </body>
</html>
